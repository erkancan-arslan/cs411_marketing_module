{% extends "layout.html" %}

{% block title %}Campaign Analytics - {{ performance.campaign_title }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1><i class="bi bi-graph-up-arrow"></i> Campaign Analytics</h1>
        <p class="mb-0">{{ performance.campaign_title }}</p>
        <small class="text-muted">Campaign ID: {{ campaign_id[:8] }}... | Status: 
            <span class="badge {% if performance.campaign_status == 'Sent' %}bg-success{% else %}bg-secondary{% endif %}">
                {{ performance.campaign_status }}
            </span>
        </small>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <!-- Total Sent -->
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <div class="text-primary mb-2">
                    <i class="bi bi-send-fill" style="font-size: 2.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ performance.sent }}</h3>
                <small class="text-muted">Emails Sent</small>
                <div class="mt-2">
                    <span class="badge bg-success">{{ performance.delivery_rate }}% Delivered</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Opened -->
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <div class="text-info mb-2">
                    <i class="bi bi-envelope-open-fill" style="font-size: 2.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ performance.opened }}</h3>
                <small class="text-muted">Emails Opened</small>
                <div class="mt-2">
                    <span class="badge bg-info">{{ performance.open_rate }}% Open Rate</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Clicked -->
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <div class="text-warning mb-2">
                    <i class="bi bi-cursor-fill" style="font-size: 2.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ performance.clicked }}</h3>
                <small class="text-muted">Link Clicks</small>
                <div class="mt-2">
                    <span class="badge bg-warning">{{ performance.click_rate }}% Click Rate</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ROI Prediction -->
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <div class="text-success mb-2">
                    <i class="bi bi-currency-dollar" style="font-size: 2.5rem;"></i>
                </div>
                <h3 class="mb-0">${{ performance.roi_prediction }}</h3>
                <small class="text-muted">Predicted Revenue</small>
                <div class="mt-2">
                    <span class="badge bg-success">Engagement: {{ performance.engagement_score }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Funnel Chart -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Engagement Funnel</h5>
            </div>
            <div class="card-body">
                <canvas id="funnelChart" height="80"></canvas>
            </div>
            <div class="card-footer text-muted small">
                <i class="bi bi-info-circle"></i> 
                Shows the customer journey from email delivery to engagement
            </div>
        </div>
    </div>
    
    <!-- Device Distribution Pie Chart -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-phone"></i> Device Breakdown</h5>
            </div>
            <div class="card-body">
                <canvas id="deviceChart"></canvas>
            </div>
            <div class="card-footer text-muted small">
                <i class="bi bi-info-circle"></i> 
                Email opens by device type
            </div>
        </div>
    </div>
</div>

<!-- Geographic Distribution -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Geographic Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="geoChart"></canvas>
            </div>
            <div class="card-footer text-muted small">
                <i class="bi bi-info-circle"></i> 
                Target audience distribution by city
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Performance Metrics</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Delivery Rate</strong></td>
                            <td class="text-end">
                                <span class="badge bg-success">{{ performance.delivery_rate }}%</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Open Rate</strong></td>
                            <td class="text-end">
                                <span class="badge bg-info">{{ performance.open_rate }}%</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Click-Through Rate (CTR)</strong></td>
                            <td class="text-end">
                                <span class="badge bg-warning">{{ performance.click_through_rate }}%</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Click Rate (of Opens)</strong></td>
                            <td class="text-end">
                                <span class="badge bg-warning">{{ performance.click_rate }}%</span>
                            </td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>Engagement Score</strong></td>
                            <td class="text-end">
                                <span class="badge 
                                    {% if performance.engagement_score >= 70 %}bg-success
                                    {% elif performance.engagement_score >= 40 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ performance.engagement_score }}/100
                                </span>
                            </td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>Predicted Revenue</strong></td>
                            <td class="text-end">
                                <strong class="text-success">${{ performance.roi_prediction }}</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info small mb-0">
                    <i class="bi bi-lightbulb"></i> 
                    <strong>Revenue Calculation:</strong> Assumes $15 average value per click 
                    (10% conversion rate Ã— $150 average order value)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Target Criteria -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bullseye"></i> Target Segment Criteria</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if performance.target_criteria.city %}
                    <div class="col-md-3">
                        <strong>City:</strong>
                        <span class="badge bg-light text-dark">{{ performance.target_criteria.city }}</span>
                    </div>
                    {% endif %}
                    
                    {% if performance.target_criteria.min_age or performance.target_criteria.max_age %}
                    <div class="col-md-3">
                        <strong>Age Range:</strong>
                        <span class="badge bg-light text-dark">
                            {{ performance.target_criteria.min_age|default('Any') }} - 
                            {{ performance.target_criteria.max_age|default('Any') }}
                        </span>
                    </div>
                    {% endif %}
                    
                    {% if performance.target_criteria.min_spending_score or performance.target_criteria.max_spending_score %}
                    <div class="col-md-3">
                        <strong>Spending Score:</strong>
                        <span class="badge bg-light text-dark">
                            {{ performance.target_criteria.min_spending_score|default('Any') }} - 
                            {{ performance.target_criteria.max_spending_score|default('Any') }}
                        </span>
                    </div>
                    {% endif %}
                    
                    {% if performance.target_criteria.is_active is not none %}
                    <div class="col-md-3">
                        <strong>Status:</strong>
                        <span class="badge {% if performance.target_criteria.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ 'Active' if performance.target_criteria.is_active else 'Inactive' }}
                        </span>
                    </div>
                    {% endif %}
                </div>
                
                {% if not performance.target_criteria %}
                <p class="text-muted mb-0">No specific targeting criteria (all customers)</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row">
    <div class="col-12">
        <a href="{{ url_for('campaign_detail', campaign_id=campaign_id) }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Campaign
        </a>
        <a href="{{ url_for('campaigns_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> All Campaigns
        </a>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Color scheme
const colors = {
    primary: 'rgba(13, 110, 253, 0.8)',
    success: 'rgba(25, 135, 84, 0.8)',
    info: 'rgba(13, 202, 240, 0.8)',
    warning: 'rgba(255, 193, 7, 0.8)',
    danger: 'rgba(220, 53, 69, 0.8)',
    secondary: 'rgba(108, 117, 125, 0.8)'
};

// ============================================================================
// 1. Engagement Funnel Chart (Horizontal Bar)
// ============================================================================
const funnelCtx = document.getElementById('funnelChart').getContext('2d');
const funnelChart = new Chart(funnelCtx, {
    type: 'bar',
    data: {
        labels: ['Sent', 'Opened', 'Clicked'],
        datasets: [{
            label: 'Email Engagement',
            data: [
                {{ performance.sent }},
                {{ performance.opened }},
                {{ performance.clicked }}
            ],
            backgroundColor: [
                colors.primary,
                colors.info,
                colors.warning
            ],
            borderColor: [
                colors.primary.replace('0.8', '1'),
                colors.info.replace('0.8', '1'),
                colors.warning.replace('0.8', '1')
            ],
            borderWidth: 2
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            title: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label;
                        const value = context.parsed.x;
                        const total = {{ performance.sent }};
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value} (${percentage}% of sent)`;
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        }
    }
});

// ============================================================================
// 2. Device Distribution Pie Chart
// ============================================================================
const deviceCtx = document.getElementById('deviceChart').getContext('2d');
const deviceChart = new Chart(deviceCtx, {
    type: 'doughnut',
    data: {
        labels: ['Mobile', 'Desktop', 'Tablet'],
        datasets: [{
            data: [
                {{ device_dist.Mobile }},
                {{ device_dist.Desktop }},
                {{ device_dist.Tablet }}
            ],
            backgroundColor: [
                colors.primary,
                colors.success,
                colors.info
            ],
            borderColor: '#fff',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label;
                        const value = context.parsed;
                        return `${label}: ${value}%`;
                    }
                }
            }
        }
    }
});

// ============================================================================
// 3. Geographic Distribution Bar Chart
// ============================================================================
const geoCtx = document.getElementById('geoChart').getContext('2d');
const geoChart = new Chart(geoCtx, {
    type: 'bar',
    data: {
        labels: {{ geo_labels|tojson }},
        datasets: [{
            label: 'Customers Targeted',
            data: {{ geo_values|tojson }},
            backgroundColor: colors.success,
            borderColor: colors.success.replace('0.8', '1'),
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        }
    }
});
</script>

{% endblock %}
